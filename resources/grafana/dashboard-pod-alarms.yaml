apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-pod-alarms-dashboard
  labels:
     grafana_dashboard: "true"
data:
  kubernetes-pod-alarms.json: |-
      {
          "annotations": {
            "list": [
              {
                "builtIn": 1,
                "datasource": "-- Grafana --",
                "enable": true,
                "hide": true,
                "iconColor": "rgba(0, 211, 255, 1)",
                "name": "Annotations & Alerts",
                "type": "dashboard"
              }
            ]
          },
          "editable": false,
          "gnetId": null,
          "graphTooltip": 0,
          "hideControls": false,
          "links": [],
          "rows": [
            {
              "collapse": false,
              "height": "250px",
              "panels": [
                {
                  "alert": {
                    "conditions": [
                      {
                        "evaluator": {
                          "params": [
                            2
                          ],
                          "type": "gt"
                        },
                        "operator": {
                          "type": "and"
                        },
                        "query": {
                          "params": [
                            "A",
                            "5m",
                            "now"
                          ]
                        },
                        "reducer": {
                          "params": [],
                          "type": "max"
                        },
                        "type": "query"
                      }
                    ],
                    "executionErrorState": "alerting",
                    "frequency": "60s",
                    "handler": 1,
                    "name": "Pod Restarts Alert",
                    "noDataState": "alerting",
                    "notifications": []
                  },
                  "aliasColors": {},
                  "bars": false,
                  "dashLength": 10,
                  "dashes": false,
                  "datasource": "Prometheus",
                  "fill": 1,
                  "id": 1,
                  "legend": {
                    "avg": false,
                    "current": false,
                    "hideEmpty": true,
                    "hideZero": true,
                    "max": false,
                    "min": false,
                    "rightSide": true,
                    "show": false,
                    "total": false,
                    "values": false
                  },
                  "lines": true,
                  "linewidth": 1,
                  "links": [],
                  "nullPointMode": "null",
                  "percentage": false,
                  "pointradius": 5,
                  "points": false,
                  "renderer": "flot",
                  "seriesOverrides": [],
                  "spaceLength": 10,
                  "span": 12,
                  "stack": false,
                  "steppedLine": false,
                  "targets": [
                    {
                      "expr": "increase(kube_pod_container_status_restarts_total[5m])",
                      "format": "time_series",
                      "intervalFactor": 2,
                      "legendFormat": "{{container}}",
                      "metric": "kube_pod_container_status_restarts_total",
                      "refId": "A",
                      "step": 30
                    }
                  ],
                  "thresholds": [
                    {
                      "colorMode": "critical",
                      "fill": true,
                      "line": true,
                      "op": "gt",
                      "value": 2
                    }
                  ],
                  "timeFrom": null,
                  "timeShift": null,
                  "title": "Pod Restarts [5m]",
                  "tooltip": {
                    "shared": true,
                    "sort": 0,
                    "value_type": "individual"
                  },
                  "type": "graph",
                  "xaxis": {
                    "buckets": null,
                    "mode": "time",
                    "name": null,
                    "show": true,
                    "values": []
                  },
                  "yaxes": [
                    {
                      "format": "short",
                      "label": null,
                      "logBase": 1,
                      "max": null,
                      "min": "0",
                      "show": true
                    },
                    {
                      "format": "short",
                      "label": null,
                      "logBase": 1,
                      "max": null,
                      "min": null,
                      "show": true
                    }
                  ]
                }
              ],
              "repeat": null,
              "repeatIteration": null,
              "repeatRowId": null,
              "showTitle": false,
              "title": "Dashboard Row",
              "titleSize": "h6"
            },
            {
              "collapse": false,
              "height": 250,
              "panels": [
                {
                  "alert": {
                    "conditions": [
                      {
                        "evaluator": {
                          "params": [
                            0.9
                          ],
                          "type": "gt"
                        },
                        "operator": {
                          "type": "and"
                        },
                        "query": {
                          "params": [
                            "A",
                            "5m",
                            "now"
                          ]
                        },
                        "reducer": {
                          "params": [],
                          "type": "avg"
                        },
                        "type": "query"
                      }
                    ],
                    "executionErrorState": "alerting",
                    "frequency": "60s",
                    "handler": 1,
                    "name": "Pods Not Running Alert",
                    "noDataState": "ok",
                    "notifications": []
                  },
                  "aliasColors": {},
                  "bars": false,
                  "dashLength": 10,
                  "dashes": false,
                  "datasource": "Prometheus",
                  "fill": 1,
                  "id": 2,
                  "legend": {
                    "avg": false,
                    "current": false,
                    "hideEmpty": true,
                    "hideZero": true,
                    "max": false,
                    "min": false,
                    "show": true,
                    "total": false,
                    "values": false
                  },
                  "lines": true,
                  "linewidth": 1,
                  "links": [],
                  "nullPointMode": "null as zero",
                  "percentage": false,
                  "pointradius": 5,
                  "points": false,
                  "renderer": "flot",
                  "seriesOverrides": [],
                  "spaceLength": 10,
                  "span": 12,
                  "stack": false,
                  "steppedLine": false,
                  "targets": [
                    {
                      "expr": "kube_pod_status_phase{phase != \"Running\"}",
                      "format": "time_series",
                      "intervalFactor": 2,
                      "legendFormat": "{{pod}}",
                      "metric": "kube_pod_container_status_waiting",
                      "refId": "A",
                      "step": 30
                    }
                  ],
                  "thresholds": [
                    {
                      "colorMode": "critical",
                      "fill": true,
                      "line": true,
                      "op": "gt",
                      "value": 0.9
                    }
                  ],
                  "timeFrom": null,
                  "timeShift": null,
                  "title": "Pods Not Running [5m]",
                  "tooltip": {
                    "shared": true,
                    "sort": 0,
                    "value_type": "individual"
                  },
                  "type": "graph",
                  "xaxis": {
                    "buckets": null,
                    "mode": "time",
                    "name": null,
                    "show": true,
                    "values": []
                  },
                  "yaxes": [
                    {
                      "format": "short",
                      "label": null,
                      "logBase": 1,
                      "max": null,
                      "min": "0",
                      "show": true
                    },
                    {
                      "format": "short",
                      "label": null,
                      "logBase": 1,
                      "max": null,
                      "min": null,
                      "show": true
                    }
                  ]
                }
              ],
              "repeat": null,
              "repeatIteration": null,
              "repeatRowId": null,
              "showTitle": false,
              "title": "Dashboard Row",
              "titleSize": "h6"
            }
          ],
          "schemaVersion": 14,
          "style": "dark",
          "tags": [
            "kubernetes",
            "alarms"
          ],
          "templating": {
            "list": []
          },
          "time": {
            "from": "now-7d",
            "to": "now"
          },
          "timepicker": {
            "refresh_intervals": [
              "5s",
              "10s",
              "30s",
              "1m",
              "5m",
              "15m",
              "30m",
              "1h",
              "2h",
              "1d"
            ],
            "time_options": [
              "5m",
              "15m",
              "1h",
              "6h",
              "12h",
              "24h",
              "2d",
              "7d",
              "30d"
            ]
          },
          "timezone": "",
          "title": "Kubernetes Pod Alarms",
          "version": 8
        }
